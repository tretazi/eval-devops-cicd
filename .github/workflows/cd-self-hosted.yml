name: CD - Deploy Self-Hosted

on:
  workflow_run:
    workflows: ["CI - Tests HTML"]
    types:
      - completed

jobs:
  deploy:
    # ‚ö†Ô∏è Condition CRITIQUE : ne d√©ploie que si CI r√©ussit
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, linux, x64]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: D√©ploiement sur le serveur Nginx
        run: |
          echo "üöÄ D√©ploiement du site sur le serveur..."
          sudo cp -f index.html /var/www/devops-eval/
          echo "‚úÖ Fichier index.html copi√© dans /var/www/devops-eval/"
      
      - name: V√©rification du d√©ploiement
        run: |
          echo "üîç V√©rification du d√©ploiement..."
          if curl -s http://localhost | grep -q "TP DevOps"; then
            echo "‚úÖ Site accessible et fonctionnel !"
          else
            echo "‚ùå Erreur : le site n'est pas accessible"
            exit 1
          fi
      
      - name: Affichage des informations
        run: |
          echo "üìä Informations du serveur :"
          echo "Hostname: $(hostname)"
          echo "User: $(whoami)"
          echo "Date: $(date)"